/**
 * Author: xjiancong@gmail.com
 * Date: 2013-12-31
 *
 *                       _oo0oo_
 *                      o8888888o
 *                      88" . "88
 *                      (| -_- |)
 *                      0\  =  /0
 *                    ___/'---'\___
 *                  .' \\|     |// '.
 *                 / \\|||  :  |||// \
 *                / _||||| -:- |||||- \
 *               |   | \\\  -  /// |   |
 *               | \_|  ''\---/''  |_/ |
 *               \  .-\__  '-'  ___/-. /
 *             ___'. .'  /--.--\  `. .'___
 *          ."" '<  '.___\_<|>_/___.'  >' "".
 *         | | :  `- \`.;`\ _ /`;.`/ - ` : | |
 *         \  \ '_.   \_ __\ /__ _/   ._' /  /
 *     ====='-.____-.___ \_____/ ___.-____.-'=====
 *                       '=---='
 *
 *
 *     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
 *
 *                 佛祖保佑       永无BUG
 */
define("dist/main",["./util","./jquery_placeholder"],function(a){function b(a){var b,d=$(".list"),e=[],f=0;e.push('<li title="双击聊天" alt="all" class="sayingto" onselectstart="return false">所有人</li>');for(var g in a)b=a[g]===h?' style="color:#f00;"':"",e.push('<li alt="'+a[g]+'" title="双击聊天" onselectstart="return false"'+b+">"+a[g]+"</li>"),f++;d.find(".online").text(f).end().find("ul").html(e.join("")),d.on("dblclick","li",function(){$(this).attr("alt")!=h&&(i=$(this).attr("alt"),$(".list ul > li").removeClass("sayingto"),$(this).addClass("sayingto"),c())})}function c(){$("#from").html(h),$("#to").html("all"==i?"所有人":i)}function d(){var a=new Date,b=a.getFullYear()+"-"+(a.getMonth()+1)+"-"+a.getDate()+" "+a.getHours()+":"+(a.getMinutes()<10?"0"+a.getMinutes():a.getMinutes())+":"+(a.getSeconds()<10?"0"+a.getSeconds():a.getSeconds());return b}var e=a("./util"),f=(a("./jquery_placeholder"),$(".message")),g=$(".chatArea"),h=decodeURIComponent(e.getCookie("chat_user")),i="all";socket=io.connect(),$("input[placeholder], textarea[placeholder]").placeholder(),socket.emit("online",{user:h}),socket.on("online",function(a){var e;e=a.user!==h?'<div class="info-tip">System ('+d()+"): 用户 "+a.user+" 上线了！</div>":'<div class="info-tip">System ('+d()+"): 欢迎进入聊天室！</div>",f.append(e),b(a.users),c()}),socket.on("say",function(a){var b;"all"===a.to?b='<div class="chatinfo">'+a.from+" ("+d()+") 对 所有人 说: <br/>"+a.msg+"</div>":a.to==h&&(b='<div class="chatinfo" style="color:#00f;">'+a.from+" ("+d()+") 对 你 说: <br/>"+a.msg+"</div>"),f.append(b)}),socket.on("offline",function(a){var e='<div class="info-tip">System ('+d()+"): 用户 "+a.user+" 下线了！</div>";f.append(e),b(a.users),a.user===i&&(i="all"),c()}),socket.on("disconnect",function(){var a='<div class="info-tip">System ('+d()+"): 连接服务器失败！</div>";f.append(a),$(".list ul").html("")}),socket.on("reconnect",function(){var a='<div class="info-tip">System ('+d()+"): 重新连接服务器！</div>";f.append(a),socket.emit("online",{user:h})}),$(".submit").on("click",function(){var a,b=g.val();b&&(a="all"===i?'<div class="chatinfo">你 ('+d()+") 对 所有人 说: <br/>"+b+"</div>":'<div class="chatinfo" style="color:#00f;">你 ('+d()+") 对 "+i+" 说: <br/>"+b+"</div>",f.append(a),socket.emit("say",{from:h,to:i,msg:b}),g.val("").focus())})}),define("dist/util",[],function(){var a={throttle:function(a,b){var c,d,e,f,g,h,i=this.debounce(function(){g=f=!1},b);return function(){c=this,d=arguments;var j=function(){e=null,g&&a.apply(c,d),i()};return e||(e=setTimeout(j,b)),f?g=!0:h=a.apply(c,d),i(),f=!0,h}},debounce:function(a,b,c){var d;return function(){var e=this,f=arguments,g=function(){d=null,c||a.apply(e,f)};c&&!d&&a.apply(e,f),clearTimeout(d),d=setTimeout(g,b)}},setCookie:function(a,b,c){var d=new Date;c=c||7,d.setTime(d.getTime()+24*c*60*60*1e3),document.cookie=a+"="+b+"; expires="+d.toGMTString()+"; path=/"},getCookie:function(a){var b=a+"=";return document.cookie.length>0?(offset=document.cookie.indexOf(b),-1!=offset?(offset+=b.length,end=document.cookie.indexOf(";",offset),-1==end&&(end=document.cookie.length),document.cookie.substring(offset,end)):""):""},delCookie:function(a,b,c){this.setCookie(a,"","Thu, 01 Jan 1970 00:00:00 GMT",b,c)},JSONparse:function(a){return a&&"string"==typeof a?(a=a.trim(),window.JSON&&window.JSON.parse?window.JSON.parse(a):rValidchars.test(a.replace(rValidescape,"@").replace(rValidtokens,"]").replace(rValidbraces,""))?new Function("return "+a)():void 0):null},JSONstringify:function(a){if(window.JSON&&window.JSON.stringify)return JSON.stringify(a);var b=[];if("object"==typeof a){if(a instanceof Array){var c=[];b.push("[");for(var d=0;d<a.length;d++)c.push(this.JSONstringify(a[d]));b.push(c.join()),b.push("]")}else{b.push("{");var c=[];for(var e in a)c.push('"'+e+'":'+this.JSONstringify(a[e]));b.push(c.join()),b.push("}")}return b.join("")}return"number"!=typeof a?'"'+(a||"")+'"':a},loadJs:function(a,b,c){c=c||{};var d=document.getElementsByTagName("head")[0]||document.documentElement,e=document.createElement("script"),f=!1;e.src=a,c.charset&&(e.charset=c.charset),"async"in c&&(e.async=c.async||""),e.onerror=e.onload=e.onreadystatechange=function(){f||this.readyState&&"loaded"!=this.readyState&&"complete"!=this.readyState||(f=!0,b&&b(),e.onerror=e.onload=e.onreadystatechange=null,d.removeChild(e))},d.insertBefore(e,d.firstChild)},loadJsonp:function(){var a=1*new Date;return function(b,c,d){d=d||{};var e="XYJsonp"+a++,f=d.callbackReplacer||/%callbackfun%/gi;window[e]=function(a){c&&c(a),window[e]=null;try{delete window[e]}catch(b){}},f.test(b)?b=b.replace(f,e):b+=(/\?/.test(b)?"&":"?")+"callback="+e,this.loadJs(b,d.oncomplete,d)}}()};return a}),define("dist/jquery_placeholder",[],function(){function a(a){this.input=a,"password"==a.attr("type")&&this.handlePassword(),$(a[0].form).submit(function(){a.hasClass("placeholder")&&a[0].value==a.attr("placeholder")&&(a[0].value="")})}a.prototype={show:function(a){if(""===this.input[0].value||a&&this.valueIsPlaceholder()){if(this.isPassword)try{this.input[0].setAttribute("type","text")}catch(b){this.input.before(this.fakePassword.show()).hide()}this.input.addClass("placeholder"),this.input[0].value=this.input.attr("placeholder")}},hide:function(){if(this.valueIsPlaceholder()&&this.input.hasClass("placeholder")&&(this.input.removeClass("placeholder"),this.input[0].value="",this.isPassword)){try{this.input[0].setAttribute("type","password")}catch(a){}this.input.show(),this.input[0].focus()}},valueIsPlaceholder:function(){return this.input[0].value==this.input.attr("placeholder")},handlePassword:function(){var a=this.input;if(a.attr("realType","password"),this.isPassword=!0,$.browser.msie&&a[0].outerHTML){var b=$(a[0].outerHTML.replace(/type=(['"])?password\1/gi,"type=$1text$1"));this.fakePassword=b.val(a.attr("placeholder")).addClass("placeholder").focus(function(){a.trigger("focus"),$(this).hide()}),$(a[0].form).submit(function(){b.remove(),a.show()})}}};var b=!!("placeholder"in document.createElement("input"));$.fn.placeholder=function(){return b?this:this.each(function(){var b=$(this),c=new a(b);c.show(!0),b.focus(function(){c.hide()}),b.blur(function(){c.show(!1)}),$.browser.msie&&($(window).load(function(){b.val()&&b.removeClass("placeholder"),c.show(!0)}),b.focus(function(){if(""==this.value){var a=this.createTextRange();a.collapse(!0),a.moveStart("character",0),a.select()}}))})}});